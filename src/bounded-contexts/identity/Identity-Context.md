# Identity Bounded Context

## Overview

The **Identity** bounded context is responsible for user management and session isolation in the Cashlint accrual‑based accounting system. It ensures that each user has a unique identity and a fully isolated data sandbox, including a default Chart of Accounts, enabling multi‑tenant isolation in a single‑instance application.

## Purpose & Business Value

Cashlint is designed for sole proprietors and single‑member entities who need a private, isolated accounting environment. The Identity context provides:

1. **User Creation**: Register a new user with a unique username.
2. **Data Isolation**: Each user’s transactions, accounts, and periods are scoped to their user ID.
3. **Default Chart of Accounts**: Automatically creates a standard set of accounts (Assets, Liabilities, Equity, Revenue, Expenses) when a user is created.
4. **Session Management**: Supports browser‑based sessions with cookie‑based authentication (handled elsewhere, but relies on user identity).

Without this context, there would be no way to separate one user’s financial data from another’s, breaking the core requirement of data privacy.

## Key Concepts

### User
A user represents a single person or entity that uses the Cashlint application. A user has:

- **Username**: A unique, case‑insensitive identifier (alphanumeric + underscore, minimum 3 characters, no spaces).
- **ID**: A UUID generated by the system.
- **Created At**: Timestamp of registration.

### Default Chart of Accounts
A predefined set of accounts that every user receives upon creation. This includes the standard accounts for double‑entry accounting (e.g., Cash, Accounts Receivable, Service Revenue, etc.) as defined in the project’s default Chart of Accounts.

### Session
A browser session tied to a user via a cookie, expiring after 1 hour of inactivity. Sessions are managed by the API layer but depend on the user aggregate.

## Bounded Context Boundaries

The Identity context is distinct from:

- **Ledger Context**: Identity creates the default accounts (which are ledger entities) but does not manage journal entries.
- **Sales & Purchasing Contexts**: Those contexts operate within the scope of a user but do not create users.
- **PeriodClose Context**: Periods are scoped to a user, but user creation is independent.

## Domain Model

### Aggregate Root: `User`
The `User` aggregate enforces the following invariants:

1. **Unique Username**: No two users can have the same username (case‑insensitive).
2. **Valid Username Format**: Must be alphanumeric plus underscores, at least 3 characters, no spaces.
3. **Immutable Username**: Once created, the username cannot be changed (in v1).

### Value Objects
- `Username`: A normalized string (lowercase, trimmed) with validation.

### Domain Events
- `UserCreated`
- `UserDataReset` (future)

## Workflows

### 1. Create User
**Command**: `CreateUser`
**Steps**:
1. Validate username format and length (pure domain validation).
2. Normalize username to lowercase.
3. Check for duplicate username in the database.
4. Create a new `User` aggregate.
5. In a single transaction, persist the user and create the default Chart of Accounts (using the shared `userWithAccountsRepo`).
6. Return the created user.

**Errors**:
- `InvalidUsername` (DomainFailure)
- `DuplicateKey` (InfrastructureFailure)

### 2. Reset User Data (future)
**Command**: `ResetUserData`
**Steps**:
1. Verify the user exists.
2. Delete all user‑scoped data (accounts, journal entries, customers, vendors, periods, etc.) in a transactional manner.
3. Re‑create the default Chart of Accounts.
4. Return success.

**Errors**:
- `UserNotFound`

## Directory Structure

```
src/bounded-contexts/identity/
├── domain/
│   ├── user.ts              # User aggregate, username validation
│   ├── errors.ts            # Context‑specific error subtypes
│   └── user.test.ts         # Unit tests for domain logic
├── application/
│   ├── createUserWorkflow.ts
│   └── createUserWorkflow.test.ts
├── infrastructure/
│   ├── userRepo.ts          # Repository for User aggregate
│   ├── userRepo.test.ts
│   ├── userWithAccountsRepo.ts  # Combined user + accounts creation
│   └── userWithAccountsRepo.test.ts
└── Identity-Context.md     (this file)
```

## Dependencies

### Internal Dependencies
- **Ledger Context**: Uses the Ledger’s account creation to set up the default Chart of Accounts.
- **Shared Types**: `Result<T, AppError>`, `AppError` subtypes.

### External Dependencies
- **Prisma Client**: For database persistence.
- **Ramda**: Functional utility library used for composition.

## API Routes

The context exposes the following HTTP endpoints (see `src/api/routes/identity.ts`):

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/users` | Create a new user |
| GET | `/api/users/health` | Health check |

*Note: The `GET /api/users` endpoint (list users) is planned but not yet implemented.*

## Error Handling

All operations return a `Result<T, AppError>` where errors are categorized as:

- **DomainFailure**: Business‑rule violations (e.g., invalid username format).
- **InfrastructureFailure**: Database errors (e.g., duplicate username).
- **ApplicationFailure**: Request‑validation errors (e.g., missing username).

Error mapping to HTTP status codes is done in the API layer (`errorMapper.ts`).

## Testing Strategy

### Unit Tests
- **Domain**: Test username validation (edge cases, normalization).
- **Workflows**: Mock dependencies to test the creation flow.

### Integration Tests
- **API Routes**: Use `supertest` to verify user creation and error responses.
- **Repository**: Test database operations with a real test database.

### Key Test Scenarios
1. User creation with valid username.
2. Attempt to create a user with a duplicate username.
3. Username validation (too short, invalid characters, case normalization).
4. Default accounts are created for the new user.

## How It Fits into the Cashlint System

Identity is a **core subdomain** that provides the foundation for data isolation. It is the first context invoked when a new user signs up and is a prerequisite for all other contexts (Ledger, Sales, Purchasing, PeriodClose) because they all operate within a user’s sandbox.

## Future Enhancements

1. **User Authentication**: Add passwords and login flow.
2. **User Profile**: Allow users to update their contact information.
3. **Multi‑user Collaboration**: Allow a user to invite an accountant or bookkeeper with limited permissions.
4. **User Deactivation**: Soft‑delete users instead of hard deletion.

## Related Documentation

- [Cashlint System Design and Glossary](../contexts/Cashlint%20System%20Design%20and%20Glossary.docx)
- [Identity API Tests](../../api/routes/identity.test.md)
- [Functional Programming Error Handling Principles](../contexts/Functional%20Programming%20Error%20Handling%20Principles.md)
